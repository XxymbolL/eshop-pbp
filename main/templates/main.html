{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Alpha Shoes</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="w-full bg-gray-50 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <header class="mb-6">
      <h1 id="page-title" class="text-3xl font-bold mb-1">Shoes List</h1>
      <p class="text-gray-600">Welcome, {{ name }}</p>
    </header>

    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 bg-white border border-gray-200 rounded-md p-4">
      <div class="flex gap-3 mb-3 sm:mb-0">
        <button id="btnAll" class="px-4 py-2 rounded-md font-medium border border-gray-300">All Products</button>
        <button id="btnMy"  class="px-4 py-2 rounded-md font-medium border border-gray-300">My Products</button>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="showModal()" class="inline-block px-4 py-2 bg-black text-white rounded-md hover:bg-neutral-800">+ Add Shoes</button>
        <button id="btnRefresh" class="px-4 py-2 border border-gray-300 rounded-md">Refresh</button>
      </div>
      <div class="text-sm text-gray-600 sm:ml-4">
        Last login: {{ last_login }}
      </div>
    </div>

    <div id="stateLoading" class="bg-white border border-gray-200 rounded-md p-10 text-center">
      <div class="animate-spin w-6 h-6 border-2 border-black border-t-transparent rounded-full mx-auto mb-3"></div>
      <p class="text-gray-700">Loading…</p>
    </div>

    <div id="stateError" class="bg-white border border-gray-200 rounded-md p-10 text-center hidden">
      <p class="font-medium mb-1">Failed to load products</p>
      <p class="text-gray-600 text-sm">Please try again.</p>
    </div>

    <div id="stateEmpty" class="bg-white border border-gray-200 rounded-md p-10 text-center hidden">
      <div class="w-32 h-32 mx-auto mb-4">
        <img src="{% static 'image/noproduct.png' %}" alt="No product" class="w-full h-full object-contain">
      </div>
      <h3 class="text-lg font-medium mb-1">No products yet</h3>
      <p class="text-gray-600 mb-4">Add your shoe to the list now.</p>
      <button onclick="showModal()" class="inline-block px-4 py-2 bg-black text-white rounded-md hover:bg-neutral-800">Add Shoes</button>
    </div>

    <section id="grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></section>

  </div>
</div>

{% endblock content %}

{% block scripts %}
<script>
  const API_LIST = "{% url 'main:shoes_json' %}";
  const API_DETAIL = (id) => "{% url 'main:show_shoes' '00000000-0000-0000-0000-000000000000' %}"
                              .replace('00000000-0000-0000-0000-000000000000', id);

  const grid = document.getElementById('grid');
  const boxLoading = document.getElementById('stateLoading');
  const boxError = document.getElementById('stateError');
  const boxEmpty = document.getElementById('stateEmpty');
  const btnRefresh = document.getElementById('btnRefresh');
  const btnAll = document.getElementById('btnAll');
  const btnMy = document.getElementById('btnMy');

  let activeFilter = 'all';

  function showSection({loading=false, error=false, empty=false, gridOn=false}) {
    boxLoading.classList.toggle('hidden', !loading);
    boxError.classList.toggle('hidden', !error);
    boxEmpty.classList.toggle('hidden', !empty);
    grid.classList.toggle('hidden', !gridOn);
  }

  function setFilterButtons() {
    const active = 'bg-black text-white border-transparent';
    const normal = 'border border-gray-300 bg-transparent';
    btnAll.className = 'px-4 py-2 rounded-md font-medium ' + (activeFilter === 'all' ? active : normal);
    btnMy.className  = 'px-4 py-2 rounded-md font-medium ' + (activeFilter === 'my'  ? active : normal);
  }

  function esc(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function generateCard(item) {
    const el = document.createElement('article');
    el.className = "bg-white border border-gray-200 rounded-md overflow-hidden";

    const detailUrl = API_DETAIL(item.id);
    const image = item.thumbnail
      ? `<img src="${esc(item.thumbnail)}" alt="${esc(item.name)}" class="w-full h-48 object-cover">`
      : `<div class="w-full h-48 bg-gray-100 grid place-items-center p-6">
           <img src="{% static 'image/noimage.png' %}" class="w-24 h-24 object-contain" alt="No product">
         </div>`;

    const ownerBtns = item.is_owner
      ? `<div class="flex gap-3">
           <button class="underline" onclick="openEditModal('${item.id}')">Edit</button>
           <button class="underline text-red-600" onclick="openDeleteConfirm('${item.id}', '${esc(item.name)}')">Delete</button>
         </div>`
      : '';

    el.innerHTML = `
      ${image}
      <div class="p-4">
        <h3 class="text-lg font-semibold mb-1">
          <a href="${detailUrl}" class="hover:underline">${esc(item.name)}</a>
        </h3>
        <p class="text-sm text-gray-700 mb-2">Price: ${formatRupiah(item.price)} • Stock: ${item.total_stock}</p>
        <div class="flex items-center justify-between">
          <a class="underline" href="${detailUrl}">Details</a>
          ${ownerBtns}
        </div>
      </div>`;
    return el;
  }

  async function loadList() {
    showSection({ loading: true });
    setFilterButtons();

    const url = activeFilter === 'my' ? `${API_LIST}?filter=my` : API_LIST;

    try {
      const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);

      const items = await resp.json();
      if (!Array.isArray(items) || items.length === 0) {
        showSection({ empty: true });
        return;
      }

      grid.innerHTML = '';
      for (const item of items) grid.appendChild(generateCard(item));
      showSection({ gridOn: true });
    } catch (e) {
      console.error(e);
      showSection({ error: true });
    }
  }

  btnRefresh.addEventListener('click', loadList);
  btnAll.addEventListener('click', () => { activeFilter = 'all'; loadList(); });
  btnMy .addEventListener('click', () => { activeFilter = 'my';  loadList(); });

  loadList();
</script>
{% endblock scripts %}
